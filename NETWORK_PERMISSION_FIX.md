# ç½‘ç»œæƒé™é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ”´ é—®é¢˜æè¿°

ç”¨æˆ·è®¾ç½®å¯†ç æˆåŠŸåï¼Œç«‹å³æç¤º"åº”ç”¨æƒ³è¦è·å–ç½‘ç»œæƒé™"ï¼Œä¸¥é‡å½±å“"é›¶ç½‘ç»œéšç§ç©ºé—´"çš„æ ¸å¿ƒå–ç‚¹ã€‚

## ğŸ” æ ¹æœ¬åŸå› 

1. **SwiftUI TabView é¢„åŠ è½½æœºåˆ¶**ï¼š
   - TabView ä¼šé¢„åŠ è½½æ‰€æœ‰ tab çš„è§†å›¾ï¼Œå³ä½¿ç”¨æˆ·è¿˜æ²¡åˆ‡æ¢
   - ç”¨æˆ·è¿›å…¥ MainTabView æ—¶ï¼ŒSettingsView è¢«æå‰åˆå§‹åŒ–

2. **StoreKit è‡ªåŠ¨ç½‘ç»œè¿æ¥**ï¼š
   - SettingsView ä½¿ç”¨ `@StateObject private var purchaseManager = PurchaseManager.shared`
   - PurchaseManager çš„ `init()` ä¼šç«‹å³ï¼š
     - å¯åŠ¨ `listenForTransactions()` ç›‘å¬
     - è°ƒç”¨ `updatePurchaseStatus()` æ£€æŸ¥è´­ä¹°çŠ¶æ€
   - StoreKit æ¡†æ¶ä¼šè‡ªåŠ¨è¿æ¥ App Store æœåŠ¡å™¨éªŒè¯äº§å“
   - âŒ è§¦å‘ç½‘ç»œæƒé™è¯·æ±‚å¼¹çª—

## âœ… è§£å†³æ–¹æ¡ˆï¼šå»¶è¿ŸåŠ è½½ StoreKit

### ä¿®æ”¹ 1: PurchaseManager å»¶è¿Ÿåˆå§‹åŒ–

**æ–‡ä»¶**: `ZeroNet-Space/Views/Settings/PurchaseManager.swift`

**æ ¸å¿ƒæ”¹åŠ¨**ï¼š
```swift
// âŒ æ—§ä»£ç ï¼šinit() ç«‹å³åˆå§‹åŒ– StoreKit
private init() {
    updateListenerTask = listenForTransactions()
    Task { await updatePurchaseStatus() }
}

// âœ… æ–°ä»£ç ï¼šå»¶è¿Ÿåˆå§‹åŒ–ï¼Œä»…åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶è§¦å‘
private var isStoreKitInitialized = false

private init() {
    // ä¸åœ¨ init ä¸­åˆå§‹åŒ– StoreKit
}

private func initializeStoreKitIfNeeded() {
    guard !isStoreKitInitialized else { return }
    isStoreKitInitialized = true
    
    updateListenerTask = listenForTransactions()
    Task { await updatePurchaseStatus() }
}
```

**ä¿®æ”¹ç‚¹**ï¼š
- âœ… `loadProducts()` - æ·»åŠ  `initializeStoreKitIfNeeded()` è°ƒç”¨
- âœ… `purchase()` - æ·»åŠ  `initializeStoreKitIfNeeded()` è°ƒç”¨
- âœ… `restorePurchases()` - æ·»åŠ  `initializeStoreKitIfNeeded()` è°ƒç”¨

### ä¿®æ”¹ 2: SettingsView å»¶è¿ŸåŠ è½½ IAP æ•°æ®

**æ–‡ä»¶**: `ZeroNet-Space/Views/Settings/SettingsView.swift`

**æ ¸å¿ƒæ”¹åŠ¨**ï¼š

```swift
// âŒ æ—§ä»£ç ï¼šè§†å›¾åŠ è½½æ—¶ç«‹å³è°ƒç”¨
.task {
    await loadStorageInfo()
    await loadPurchaseData()  // è§¦å‘ç½‘ç»œè¯·æ±‚
}

// âœ… æ–°ä»£ç ï¼šç§»é™¤è‡ªåŠ¨åŠ è½½
.task {
    await loadStorageInfo()
    // ä¸åœ¨è§†å›¾åŠ è½½æ—¶è°ƒç”¨ loadPurchaseData()
}
```

**æ–°å¢é€»è¾‘**ï¼š
```swift
// æ–°å¢çŠ¶æ€å˜é‡
@State private var hasLoadedPurchaseData = false

// æ‹†åˆ†æ–¹æ³•ï¼šä»…åŠ è½½åª’ä½“æ•°é‡ï¼ˆä¸è§¦å‘ç½‘ç»œï¼‰
private func loadMediaCount() async {
    let descriptor = FetchDescriptor<MediaItem>()
    currentMediaCount = (try? modelContext.fetchCount(descriptor)) ?? 0
}

// åœ¨ç”¨æˆ·ç‚¹å‡»è´­ä¹°/æ¢å¤æŒ‰é’®æ—¶æ‰åŠ è½½
private func purchaseUnlimited() {
    Task {
        if !hasLoadedPurchaseData {
            await loadPurchaseData()  // ğŸ”´ ä»…åœ¨æ­¤æ—¶è§¦å‘ç½‘ç»œ
        }
        let success = await purchaseManager.purchase()
        // ...
    }
}
```

## ğŸ“Š ä¿®æ”¹å‰åå¯¹æ¯”

| é˜¶æ®µ | ä¿®æ”¹å‰ | ä¿®æ”¹å |
|------|--------|--------|
| ç”¨æˆ·è®¾ç½®å¯†ç  | âœ… æ— ç½‘ç»œ | âœ… æ— ç½‘ç»œ |
| è¿›å…¥ MainTabView | âŒ è§¦å‘ç½‘ç»œæƒé™ | âœ… æ— ç½‘ç»œ |
| åˆ‡æ¢åˆ°è®¾ç½® tab | - | âœ… æ— ç½‘ç»œ |
| ç‚¹å‡»è´­ä¹°æŒ‰é’® | - | âš ï¸ é¦–æ¬¡è§¦å‘ç½‘ç»œï¼ˆåˆç†ï¼‰ |
| ç‚¹å‡»æ¢å¤è´­ä¹° | - | âš ï¸ é¦–æ¬¡è§¦å‘ç½‘ç»œï¼ˆåˆç†ï¼‰ |

## ğŸ§ª æµ‹è¯•éªŒè¯æ­¥éª¤

### 1. å®Œå…¨å¸è½½åº”ç”¨
```bash
# æ¨¡æ‹Ÿå™¨ä¸­åˆ é™¤åº”ç”¨ï¼ˆé•¿æŒ‰å›¾æ ‡ â†’ åˆ é™¤ï¼‰
# ç¡®ä¿æ¸…é™¤æ‰€æœ‰ç½‘ç»œæƒé™è®°å½•
```

### 2. é‡æ–°å®‰è£…å¹¶æµ‹è¯•
1. è¿è¡Œåº”ç”¨
2. è®¾ç½®å¯†ç ï¼ˆ6ä½ä»¥ä¸Šï¼‰
3. âœ… **å…³é”®éªŒè¯ç‚¹**ï¼šè¿›å…¥ä¸»ç•Œé¢åï¼Œ**ä¸åº”è¯¥**å¼¹å‡ºç½‘ç»œæƒé™è¯·æ±‚
4. åˆ‡æ¢åˆ°"è®¾ç½®" tab
5. âœ… **å…³é”®éªŒè¯ç‚¹**ï¼šæµè§ˆè®¾ç½®é¡µé¢ï¼Œ**ä¸åº”è¯¥**è§¦å‘ç½‘ç»œè¯·æ±‚
6. æ»šåŠ¨åˆ°"å¯¼å…¥é™åˆ¶ & å†…è´­"åŒºåŸŸ
7. âœ… **å…³é”®éªŒè¯ç‚¹**ï¼šæŸ¥çœ‹å¯¼å…¥æ¬¡æ•°ï¼Œ**ä¸åº”è¯¥**è§¦å‘ç½‘ç»œè¯·æ±‚
8. ç‚¹å‡»"è§£é”æ— é™å¯¼å…¥"æŒ‰é’®
9. âš ï¸ **é¢„æœŸè¡Œä¸º**ï¼šæ­¤æ—¶æ‰ä¼šå¼¹å‡ºç½‘ç»œæƒé™è¯·æ±‚ï¼ˆåˆç†ï¼Œå› ä¸ºéœ€è¦è¿æ¥ App Storeï¼‰

### 3. ç½‘ç»œæƒé™è®¾ç½®æ£€æŸ¥
```
è®¾ç½® App â†’ é›¶ç½‘ç»œç©ºé—´ â†’ æœ¬åœ°ç½‘ç»œ
åˆå§‹çŠ¶æ€åº”è¯¥æ˜¯ï¼šæœªè¯·æ±‚æƒé™ æˆ– è¯¢é—®
```

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### StoreKit ç½‘ç»œè§¦å‘ç‚¹

ä»¥ä¸‹ StoreKit API ä¼šè§¦å‘ç½‘ç»œè¿æ¥ï¼š
- âœ… `Product.products(for:)` - è·å–äº§å“ä¿¡æ¯
- âœ… `Transaction.updates` - ç›‘å¬äº¤æ˜“æ›´æ–°
- âœ… `Transaction.currentEntitlements` - æ£€æŸ¥å½“å‰æƒç›Š
- âœ… `AppStore.sync()` - åŒæ­¥è´­ä¹°è®°å½•

### å»¶è¿ŸåŠ è½½çš„å®‰å…¨æ€§

**ä¸ä¼šå½±å“çš„åŠŸèƒ½**ï¼š
- âœ… å…è´¹ç”¨æˆ·çš„å¯¼å…¥é™åˆ¶æ£€æŸ¥ï¼ˆä»æœ¬åœ°æ•°æ®åº“è¯»å–ï¼‰
- âœ… å·²è´­ä¹°ç”¨æˆ·çš„çŠ¶æ€æ¢å¤ï¼ˆStoreKit ä¼šåœ¨åå°åŒæ­¥ï¼‰
- âœ… åº”ç”¨çš„æ­£å¸¸ä½¿ç”¨æµç¨‹

**å½±å“çš„ä½“éªŒ**ï¼š
- âš ï¸ é¦–æ¬¡ç‚¹å‡»è´­ä¹°æŒ‰é’®æ—¶ï¼Œéœ€è¦ç­‰å¾… 1-2 ç§’åŠ è½½äº§å“ä¿¡æ¯
- âš ï¸ äº§å“ä»·æ ¼åœ¨é¦–æ¬¡åŠ è½½å‰æ˜¾ç¤ºä¸º "..."

### ä¸ºä»€ä¹ˆä¸ç”¨å…¶ä»–æ–¹æ¡ˆï¼Ÿ

**æ–¹æ¡ˆ Aï¼šç¦ç”¨ TabView é¢„åŠ è½½** âŒ
- SwiftUI æ²¡æœ‰æä¾›å®˜æ–¹ API
- éœ€è¦ä½¿ç”¨ UIKit wrapperï¼Œå¢åŠ å¤æ‚åº¦

**æ–¹æ¡ˆ Bï¼šå®Œå…¨ç§»é™¤ StoreKit** âŒ
- æ— æ³•å®ç°å†…è´­åŠŸèƒ½
- è¿èƒŒäº§å“éœ€æ±‚

**æ–¹æ¡ˆ Cï¼šå»¶è¿Ÿåˆå§‹åŒ– PurchaseManager** âœ… **å½“å‰æ–¹æ¡ˆ**
- é›¶ä¾µå…¥æ€§ä¿®æ”¹
- ä¿æŒä»£ç ç»“æ„ä¸å˜
- ç”¨æˆ·ä½“éªŒå½±å“æœ€å°

## ğŸ¯ æ ¸å¿ƒä»·å€¼å®ˆæŠ¤

è¿™æ¬¡ä¿®å¤ç¡®ä¿äº†ï¼š
- âœ… **é›¶ç½‘ç»œå–ç‚¹**ï¼šç”¨æˆ·åœ¨æœªä½¿ç”¨å†…è´­åŠŸèƒ½å‰ï¼Œå®Œå…¨æ— ç½‘ç»œè®¿é—®
- âœ… **éšç§ä¿æŠ¤**ï¼šæ²¡æœ‰ä»»ä½•åå°ç½‘ç»œè¯·æ±‚
- âœ… **ç”¨æˆ·ä¿¡ä»»**ï¼šä¸ä¼šåœ¨ç”¨æˆ·ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹è¯·æ±‚ç½‘ç»œæƒé™
- âœ… **åŠŸèƒ½å®Œæ•´**ï¼šå†…è´­åŠŸèƒ½åœ¨éœ€è¦æ—¶æ­£å¸¸å·¥ä½œ

## ğŸ“Œ åç»­å»ºè®®

1. **æ·»åŠ ç½‘ç»œè¯´æ˜**ï¼š
   - åœ¨å†…è´­åŒºåŸŸæ·»åŠ è¯´æ˜ï¼š"ç‚¹å‡»è´­ä¹°æ—¶éœ€è¦è¿æ¥ç½‘ç»œéªŒè¯"
   - åœ¨ç½‘ç»œéªŒè¯é¡µé¢è¡¥å……ï¼š"å†…è´­åŠŸèƒ½éœ€è¦ç½‘ç»œè¿æ¥"

2. **ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ**ï¼š
   - é¦–æ¬¡ç‚¹å‡»è´­ä¹°æ—¶æ˜¾ç¤ºåŠ è½½æç¤º
   - ç¼“å­˜äº§å“ä»·æ ¼ï¼Œé¿å…é‡å¤åŠ è½½

3. **ç›‘æ§å‘Šè­¦**ï¼š
   - ç›‘æ§ StoreKit åˆå§‹åŒ–æ—¶æœº
   - ç¡®ä¿æ²¡æœ‰å…¶ä»–ä»£ç è·¯å¾„è§¦å‘æå‰åŠ è½½
